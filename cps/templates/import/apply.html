{% extends 'includes/base.html' %}
{% load static %}

{% block title %}DENR NCR Client Portal{% endblock title %}

{% block content %}
<!-- video record -->
  <video id="preview" width="480" height="360" autoplay muted hidden></video>
    <br>
    <button id="startBtn" hidden>Start Recording</button>
<style>
.recording-indicator {
    position: fixed;          /* stay on screen */
    top: 20px;                /* distance from top */
    left: 50%;                /* horizontal center */
    transform: translateX(-50%); /* truly center horizontally */
    display: inline-flex;
    align-items: center;
    color: red;
    font-weight: bold;
    font-size: 20px;
    gap: 8px;
    z-index: 9999;            /* always on top */
    background: rgba(255,255,255,0.8); /* optional: subtle background */
    padding: 10px 15px;
    border-radius: 8px;
}

.recording-indicator .icon {
    font-size: 22px;
    animation: blink 1s infinite; /* blinking animation */
}

@keyframes blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0; }
}


#cameraBlockedModal {
    display: none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.85);
    color: white;
    font-size: 24px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    z-index: 99999;
    pointer-events: all;
}
#cameraBlockedMessage {
    background: rgba(255,0,0,0.85);
    padding: 20px 30px;
    border-radius: 12px;
}
</style>

<div id="recording" >
    <br>
    <div class="recording-indicator" id="recordingIndicator" style="display: none;" style="display: none;"> 
    <span class="icon">🔴</span>
    Recording...
</div>

<!-- Camera blocked modal -->
<div id="cameraBlockedModal">
    <div id="cameraBlockedMessage">
        ⚠️ Camera might be covered or dark.<br>
        Please uncover the camera to continue recording.
    </div>
</div>

<div class="container py-5">

    <!-- Header with Logo and Title -->
    <div class="text-center mb-4">
        <img src="{% static 'images/denr-logo.png' %}" alt="DENR Logo" style="height: 90px;">
        <h4 class="mt-2 fw-bold text-uppercase text-success">Department of Environment and Natural Resources</h4>
        <h5 class="text-muted">National Capital Region</h5>
        <hr class="mt-4">
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body px-4 py-5">

            <!-- Title -->
            <h4 class="text-center text-primary mb-4 fw-semibold">
                Permit to Import Chainsaw Application
            </h4>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-4" id="formTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-section" type="button" role="tab">
                        Application Form
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="attachments-tab" data-bs-toggle="tab" data-bs-target="#attachments-section" type="button" role="tab">
                        Attachments
                    </button>
                </li>
            </ul>

            <form id="chainsawImportForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="tab-content" id="formTabsContent">
                    <!-- Application Form Tab -->
                    <div class="tab-pane fade show active" id="form-section" role="tabpanel">

                        <label for="is_existing_permittee" class="form-label">Application Type <span class="text-danger">*</span></label>
                        <select name="is_existing_permittee" id="is_existing_permittee" class="form-select">
                            <option value="" disabled selected>-- Select --</option>
                            <option value="0">New Permittee</option>
                            <option value="1" >Existing Permittee</option>
                        </select>
                        <div class="invalid-feedback">Please select Application Type.</div>
                        
                        <!-- Permittee Name -->
                        <div class="mb-4">
                            <div class="hr-sect">General Information</div>

                            <div class="col-sm-12">
                                <p style='color:red'><i>*** Information below will be shown in the permit applied.</i></p>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="establishment" class="form-label">Permittee Name <span class="text-danger">*</span></label>
                            <select id="establishment" name="estab_id_dniis" class="form-select">
                                <option value="" disabled selected>-- Select Permittee Name --</option>
                                {% for bl in business_list %}
                                    <option 
                                        value="{{ bl.id }}"
                                        data-address="{% if bl.biz_lgu %}{{ bl.biz_address }}, {{ bl.barangay }} {% if bl.sub_lgu == bl.lgu %}{{ bl.sub_lgu }}{% else %}{{ bl.sub_lgu }} {{ bl.lgu }}{% endif %}{% else %}{{ bl.biz_address }}{% endif %}"
                                        data-email="{{ bl.email_biz }}"
                                        data-contact="{{ bl.cel_no_biz }} / {{ bl.tel_no_biz }}"
                                        data-name="{{ bl.business_name }}"
                                    >
                                        {{ bl.business_name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a Permittee Name.</div>
                        </div>
                        <input type="hidden" id="estab_name" name="estab_name">

                        <div class="mb-3 mt-3">
                            <label class="form-label">Address</label>
                            <input type="text" id="estab_address" name="estab_address" class="form-control" readonly>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="text" id="estab_email" name="estab_email" class="form-control" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact No.</label>
                                <input type="text" id="estab_contact" name="estab_contact" class="form-control" readonly>
                            </div>
                        </div>

                        <div class="hr-sect">Office / Warehouse Address Information</div>

                        <!-- Warehouse -->
                        <label class="form-label">Office / Warehouse Address <span class="text-danger">*</span></label>
                        <small class="text-muted d-block mb-2">Click "Add More" to list multiple warehouses. <i class="text-danger">*</i> Address must be within NCR.</small>

                        <div id="warehouse-address-list">
                            <div class="row mb-3 warehouse-address-item">
                                <div class="col-md-2">
                                    <select name="warehouse_city[]" class="form-control" required>
                                        <option value="" disabled selected>-- Select City --</option>
                                        <option value="Caloocan">Caloocan</option>
                                        <option value="Las Piñas">Las Piñas</option>
                                        <option value="Makati">Makati</option>
                                        <option value="Malabon">Malabon</option>
                                        <option value="Mandaluyong">Mandaluyong</option>
                                        <option value="Manila">Manila</option>
                                        <option value="Marikina">Marikina</option>
                                        <option value="Muntinlupa">Muntinlupa</option>
                                        <option value="Navotas">Navotas</option>
                                        <option value="Parañaque">Parañaque</option>
                                        <option value="Pasay">Pasay</option>
                                        <option value="Pasig">Pasig</option>
                                        <option value="Pateros">Pateros</option>
                                        <option value="Quezon City">Quezon City</option>
                                        <option value="San Juan">San Juan</option>
                                        <option value="Taguig">Taguig</option>
                                        <option value="Valenzuela">Valenzuela</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a City or Municipality.</div> 
                                </div>
                                <div class="col-md-8">
                                    <input type="text" name="warehouse_address[]" class="form-control" placeholder="Office / Warehouse Address" required>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-danger w-100 remove-warehouse-row">Remove</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="add-warehouse-row" class="btn btn-outline-secondary btn-sm mt-2">+ Add More</button>


                        
                        <div class="hr-sect">Chainsaw Details</div>
                        <!-- Brand -->
                        <div class="mb-4">
                            <label for="brand" class="form-label">Brand <span class="text-danger">*</span></label>
                            <select id="brand" name="brand" class="form-select" required>
                                <option value="" disabled selected>-- Select Brand --</option>
                                {% for brand in brands %}
                                    <option value="{{ brand.id }}">{{ brand.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a brand.</div>
                        </div>

                        <!-- Model & Quantity -->
                        <div class="mb-4">
                            <label class="form-label">Model & Quantity <span class="text-danger">*</span></label>
                            <small class="text-muted d-block mb-2">Click "Add More" to list multiple models.</small>
                            <div id="model-quantity-list">
                                <div class="row g-2 mb-2 model-quantity-item">
                                    <div class="col-md-6">
                                        <select name="model[]" class="form-select model-dropdown form-control" required>
                                            <option value="" disabled selected>-- Select Model --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="number" name="quantity[]" class="form-control" placeholder="Quantity" min="1" required>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-danger w-100 remove-row">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="add-row" class="btn btn-outline-secondary btn-sm mt-2">+ Add More</button>
                        </div>


                        <!-- Origin/Supplier -->
                        <div class="mb-4">
                            <label for="origin" class="form-label">Country of Origin<span class="text-danger">*</span></label>
                            <input type="text" id="origin" name="origin" class="form-control" placeholder="e.g., Japan">
                        </div>

                        <div class="mb-4">
                            <label for="supplier" class="form-label">Supplier<span class="text-danger">*</span></label>
                            <input type="text" id="supplier" name="supplier" class="form-control" placeholder="e.g., ABC Tools Ltd.">
                        </div>

                        <div class="mb-4">
                            <label for="address" class="form-label">Supplier Address<span class="text-danger">*</span></label>
                            <input type="text" id="address" name="address" class="form-control" placeholder="e.g., 123 Main St., Tokyo, Japan">
                        </div>

                        <div class="mb-4">
                            <label for="arrival_date" class="form-label">Expected Time of Arrival <span class="text-danger">*</span></label>
                            <small class="text-muted d-block mb-2">Expected time of arrival at port of entry and/or release from the Bureau of Customs.</small>
                            <input type="date" id="arrival_date" name="arrival_date" class="form-control">
                        </div>

                        <!-- Purpose -->
                        <div class="mb-4">
                            <label for="purpose" class="form-label">Purpose <span class="text-danger">*</span></label>
                            <select id="purpose" name="purpose" class="form-select">
                                <option value="" disabled selected>-- Select Purpose --</option>
                                <option value="Distribution/Sale">Distribution / Sale</option>
                                <option value="Personal/Legal Use">Personal / Legal Use</option>
                            </select>
                            <div class="invalid-feedback">Please select a purpose.</div>
                        </div>
                    </div>

                    <!-- Attachments Tab -->
                    <div class="tab-pane fade" id="attachments-section" role="tabpanel">
                        {% if request.session.app_type == "3" %}
                        <div class="mb-4">
                            <label class="form-label">Business Name Registration (DTI/SEC with GIS) <span class="text-danger">*</span></label>
                            <input type="file" name="dti_sec" class="form-control" accept=".pdf,.jpg,.jpeg,.png" multiple>
                        </div>
                        {% endif %}

                        <div class="mb-4">
                            <label class="form-label">Purchase Order<span class="text-danger">*</span></label>
                            <input type="file" name="purchase_order" class="form-control" accept=".pdf,.jpg,.jpeg,.png" multiple>
                        </div>

                        {% if request.session.app_type == "1" or request.session.app_type == "2" %}
                        <div class="mb-4">
                            <label class="form-label">Affidavit for Legal Purpose <span class="text-danger">*</span></label>
                            <input type="file" name="affidavit" class="form-control" accept=".pdf,.jpg,.jpeg,.png" multiple>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Submit -->
                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-success px-4">Submit Application</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript for dynamic Model/Quantity rows -->
<script>
    $(document).ready(function () {
        function loadModels(brandId, dropdown) {
            if (!brandId) return;

            $.ajax({
                url: '{% url "get_chainsaw_models" %}',
                data: { brand_id: brandId },
                success: function (data) {
                    dropdown.empty().append('<option disabled selected>-- Select Model --</option>');
                    data.models.forEach(function (model) {
                        dropdown.append('<option value="' + model.name + '">' + model.name + '</option>');
                    });
                }
            });
        }

        $('#brand').on('change', function () {
            const brandId = $(this).val();
            $('#model-quantity-list .model-dropdown').each(function () {
                loadModels(brandId, $(this));
            });
        });

        // add model and quantity rows
        $('#add-row').on('click', function () {
            const newRow = `
                <div class="row g-2 mb-2 model-quantity-item">
                    <div class="col-md-6">
                        <select name="model[]" class="form-select model-dropdown form-control" required>
                            <option value="" disabled selected>-- Select Model --</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" name="quantity[]" class="form-control" placeholder="Quantity" min="1" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger w-100 remove-row">Remove</button>
                    </div>
                </div>`;
            $('#model-quantity-list').append(newRow);

            const brandId = $('#brand').val();
            loadModels(brandId, $('#model-quantity-list .model-dropdown').last());
        });

        $(document).on('click', '.remove-row', function () {
            $(this).closest('.model-quantity-item').remove();
        });

        //add warehouse and address rows
        $('#add-warehouse-row').on('click', function () {
            const newWarehouseRow = `
                <div class="row mb-3 warehouse-address-item">
                    <div class="col-md-2">
                        <select name="warehouse_city[]" class="form-control" required>
                            <option value="" disabled selected>-- Select City --</option>
                            <option value="Caloocan">Caloocan</option>
                            <option value="Las Piñas">Las Piñas</option>
                            <option value="Makati">Makati</option>
                            <option value="Malabon">Malabon</option>
                            <option value="Mandaluyong">Mandaluyong</option>
                            <option value="Manila">Manila</option>
                            <option value="Marikina">Marikina</option>
                            <option value="Muntinlupa">Muntinlupa</option>
                            <option value="Navotas">Navotas</option>
                            <option value="Parañaque">Parañaque</option>
                            <option value="Pasay">Pasay</option>
                            <option value="Pasig">Pasig</option>
                            <option value="Pateros">Pateros</option>
                            <option value="Quezon City">Quezon City</option>
                            <option value="San Juan">San Juan</option>
                            <option value="Taguig">Taguig</option>
                            <option value="Valenzuela">Valenzuela</option>
                        </select>
                        <div class="invalid-feedback">Please select a City or Municipality.</div> 
                    </div>
                    <div class="col-md-8">
                        <input type="text" name="warehouse_address[]" class="form-control" placeholder="Office / Warehouse Address" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger w-100 remove-warehouse-row">Remove</button>
                    </div>
                </div>`;
            $('#warehouse-address-list').append(newWarehouseRow);
        });

        $(document).on('click', '.remove-warehouse-row', function () {
            $(this).closest('.warehouse-address-item').remove();
        });
    });

    {% comment %} document.getElementById('add-row').addEventListener('click', function () {
        const container = document.getElementById('model-quantity-list');
        const newRow = document.createElement('div');
        newRow.className = 'row g-2 mb-2 model-quantity-item';
        newRow.innerHTML = `
            <div class="col-md-6">
                <input type="text" name="model[]" class="form-control" placeholder="Model">
            </div>
            <div class="col-md-4">
                <input type="number" name="quantity[]" class="form-control" placeholder="Quantity" min="1">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger w-100 remove-row">Remove</button>
            </div>
        `;
        container.appendChild(newRow);
    }); {% endcomment %}

    {% comment %} document.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-row')) {
            e.target.closest('.model-quantity-item').remove();
        }
    }); {% endcomment %}

    $(document).on('submit', '#chainsawImportForm', function (e) {
        e.preventDefault();

        // Clear previous error styles
        $('#chainsawImportForm input, #chainsawImportForm select').removeClass('is-invalid');

        let hasError = false;
        let firstErrorTab = null;

        if (!$('#is_existing_permittee').val()) {
            $('#is_existing_permittee').addClass('is-invalid');
            hasError = true;
            firstErrorTab = 'form-section';
        }

        if (!$('#establishment').val()) {
            $('#establishment').addClass('is-invalid');
            hasError = true;
            firstErrorTab = 'form-section';
        }

        // Validate Brand dropdown
        if (!$('#brand').val()) {
            $('#brand').addClass('is-invalid');
            hasError = true;
            firstErrorTab = 'form-section';
        }

        // Validate Purpose dropdown
        if (!$('#purpose').val()) {
            $('#purpose').addClass('is-invalid');
            hasError = true;
            firstErrorTab = 'form-section';
        }

        // Validate Origin
        const origin = $('#origin');
        if (!origin.val().trim()) {
            origin.addClass('is-invalid');
            hasError = true;
            firstErrorTab = 'form-section';
        }

        // Added Supplier & Address Validations
        // Validate Supplier
        const supplier = $('#supplier');
        if (!supplier.val().trim()) {
            supplier.addClass('is-invalid');
            hasError = true;
            firstErrorTab = 'form-section';
        }

        // Validate Address
        const address = $('#address');
        if (!address.val().trim()) {
            address.addClass('is-invalid');
            hasError = true;
            firstErrorTab = 'form-section';
        }

        const arrival_date = $('#arrival_date');
        if (!arrival_date.val().trim()) {
            arrival_date.addClass('is-invalid');
            hasError = true;
            firstErrorTab = 'form-section';
        }

        $('#warehouse-address-list .warehouse-address-item').each(function () {
            const city = $(this).find('select[name="warehouse_city[]"]');
            const address = $(this).find('input[name="warehouse_address[]"]');

            if (!city.val()) {
                city.addClass('is-invalid');
                hasError = true;
                firstErrorTab = 'form-section'; // or the tab id where warehouse address is located
            } else {
                city.removeClass('is-invalid');
            }

            if (!address.val().trim()) {
                address.addClass('is-invalid');
                hasError = true;
                firstErrorTab = 'form-section'; // or the tab id where warehouse address is located
            } else {
                address.removeClass('is-invalid');
            }
        });
        

        // Validate Model and Quantity rows
        $('#model-quantity-list .model-quantity-item').each(function () {
            const model = $(this).find('select[name="model[]"]'); // changed from input to select
            const qty = $(this).find('input[name="quantity[]"]');

            if (!model.val()) {
                model.addClass('is-invalid');
                hasError = true;
                firstErrorTab = 'form-section';
            } else {
                model.removeClass('is-invalid');
            }

            if (!qty.val() || parseInt(qty.val()) < 1) {
                qty.addClass('is-invalid');
                hasError = true;
                firstErrorTab = 'form-section';
            } else {
                qty.removeClass('is-invalid');
            }
        });


        // Validate file inputs
        $('#attachments-section input[type="file"]').each(function () {
            if (!$(this).val()) {
                $(this).addClass('is-invalid');
                hasError = true;
                if (!firstErrorTab) firstErrorTab = 'attachments-section';
            }
        });

        // If there's an error, switch to the tab
        if (hasError) {
            $(`#formTabs button[data-bs-target="#${firstErrorTab}"]`).tab('show');
            return;
        }

        // Confirm submission
        Swal.fire({
            title: "Confirm Submission",
            text: "Are you sure you want to submit this application?",
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#198754",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, submit it"
        }).then((result) => {
            if (result.isConfirmed) {
                const form = $('#chainsawImportForm')[0];
                const formData = new FormData(form);

                $.ajax({
                    url: "{% url 'submit_import' %}",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        if (response.success) {
                            // stop video
                            const app_id = response.app_id; // ← get the new application ID
                            mediaRecorder.onstop = () => {
                                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                                const now = new Date();
                                const yyyy = now.getFullYear();
                                const mm = String(now.getMonth() + 1).padStart(2, '0');
                                const dd = String(now.getDate()).padStart(2, '0');
                                const timestamp = `${yyyy}${mm}${dd}`;
                                
                                const filename = `recording_cps_${timestamp}_${app_id}.webm`;

                                const uploadForm = new FormData();
                                uploadForm.append('video', blob, filename);
                                uploadForm.append('app_id', app_id); // optional

                                fetch('/upload-video/', {
                                    method: 'POST',
                                    body: uploadForm
                                })
                                .then(res => res.json())
                                .then(data => {
                                    console.log('Uploaded:', filename);

                                    // ✅ Show success message AFTER upload completes
                                    Swal.fire({
                                        icon: "success",
                                        title: "Application Submitted",
                                        text: response.message,
                                    }).then(() => {
                                        window.location.href = "/myapplications/";
                                    });
                                })
                                .catch(err => {
                                    console.error('Upload failed:', err);

                                    // Show error message if upload failed
                                    Swal.fire({
                                        icon: "error",
                                        title: "Upload Failed",
                                        text: "Your video could not be uploaded. Please try again.",
                                    });
                                });
                            };

                            const indicator = document.getElementById('recordingIndicator');
                            indicator.style.display = 'none';
                            mediaRecorder.stop(); 
                        } else {
                            Swal.fire({
                                icon: "error",
                                title: "Submission Failed",
                                text: response.message || "Something went wrong.",
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = "/myapplications/"; // Redirect on Application List
                                }
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: "error",
                            title: "Server Error",
                            text: "An error occurred. Please try again later.",
                        });
                    }
                });
            }
        });
    });

    $('#establishment').on('change', function () {
        const selected = $(this).find(':selected');

        // Get data from selected option
        const address = selected.data('address') || '';
        const email = selected.data('email') || '';
        const contact = selected.data('contact') || '';
        const name = selected.data('name') || '';

        // Set the values
        $('#estab_address').val(address);
        $('#estab_email').val(email);
        $('#estab_contact').val(contact);
        $('#estab_name').val(name);
    });

    // ------------------------- video record -------------------------
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const modal = document.getElementById('cameraBlockedModal');

    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];

    // Data privacy consent popup
    async function showPrivacyConsent() {
        const { value: consent } = await Swal.fire({
            title: 'Data Privacy Consent',
            html: `
                <p style="text-align:justify;">&nbsp;&nbsp;&nbsp;&nbsp;By proceeding with your application and submitting your Personal Data to DENR-NCR signifies that you have read and understood this Data Privacy Notice and expressly consent to the collection and processing of your personal, sensitive personal, or privileged information in the manner and for the purpose of this Notice. Further, in continuing you understand and accept the terms and conditions provided herein with respect to your personal information pursuant to the Data Privacy Act. You also authorized DENR-NCR to record the whole procedure of processing your application.</p>
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                    <input type="checkbox" id="privacyCheckbox" style="width: 16px; height: 16px;">
                    <label for="privacyCheckbox" style="font-size: 16px; font-weight: normal;">I agree to the data privacy terms</label>
                </div>
            `,
            confirmButtonText: 'Start Recording',
            focusConfirm: false,
            preConfirm: () => {
                const checkbox = Swal.getPopup().querySelector('#privacyCheckbox');
                if (!checkbox.checked) {
                    Swal.showValidationMessage('You must agree to the data privacy terms to proceed.');
                    return false;
                }
                return true;
            },
            allowOutsideClick: false,
            allowEscapeKey: false,
        });

        if (consent) {
            initCamera();
        } else {
            window.location.href = "/dashboard/";
        }
    }

    // Initialize camera
    async function initCamera() {
        try {
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            preview.srcObject = mediaStream;
            startBtn.disabled = false;
            startBtn.click(); // auto-start recording
        } catch (err) {
            Swal.fire({
                title: "Permission denied",
                text: "Access to camera denied. Please grant permission to use your camera.",
                icon: "error",
                showCancelButton: true,
                confirmButtonColor: "#198754",
                cancelButtonColor: "#d33",
                confirmButtonText: "Allow",
                cancelButtonText: "Deny"
            }).then((result) => {
                if (result.isConfirmed) initCamera();
                else window.location.href = "/dashboard/";
            });
        }
    }

    // Start recording
   startBtn.addEventListener('click', () => {
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(mediaStream, {
            mimeType: 'video/webm; codecs=vp9',
            videoBitsPerSecond: 2500000,
            keyFrameInterval: 60
        });

        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };

        // Show the blinking indicator
        const indicator = document.getElementById('recordingIndicator');
        indicator.style.display = 'inline-flex';
        mediaRecorder.start();

        // Start camera blockage monitoring
        preview.addEventListener('loadedmetadata', () => {
            preview.play();
            monitorCameraBlocked();
        });
    });

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            const preview = document.getElementById('preview');
            preview.srcObject = stream;
            preview.play();

            // Start monitoring after camera is running
            monitorCameraBlocked();    // ← your detection function
        } catch (err) {
            console.error("Could not start camera:", err);
        }
    }

    // Monitor camera frames to detect blockage
    const monitorCanvas = document.createElement('canvas');
    const monitorCtx = monitorCanvas.getContext('2d');
    let monitorInterval = null;


    async function monitorCameraBlocked() {
        if (!preview.videoWidth || !preview.videoHeight) {
            requestAnimationFrame(monitorCameraBlocked);
            return;
        }

        monitorCanvas.width = preview.videoWidth;
        monitorCanvas.height = preview.videoHeight;

        if (monitorInterval) clearInterval(monitorInterval);

        monitorInterval = setInterval(async () => {
            // ------- BRIGHTNESS CHECK --------
            monitorCtx.drawImage(preview, 0, 0, monitorCanvas.width, monitorCanvas.height);
            const frame = monitorCtx.getImageData(0, 0, monitorCanvas.width, monitorCanvas.height);
            let sum = 0;

            for (let i = 0; i < frame.data.length; i += 4) {
                const r = frame.data[i];
                const g = frame.data[i + 1];
                const b = frame.data[i + 2];
                sum += 0.299 * r + 0.587 * g + 0.114 * b;
            }

            const avgBrightness = sum / (frame.data.length / 4);

            // ------- FACE / LANDMARK CHECK --------
            const detection = await faceapi.detectSingleFace(preview, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true);

            // Condition: dark OR no face detected OR no landmarks (eyes, nose, mouth)
            const isDark = avgBrightness < 40;
            const noFace    = !detection;
            const noLandmarks = !(detection && detection.landmarks);

            if (isDark || noFace || noLandmarks) {
                modal.style.display = 'flex';
                document.getElementById('recordingIndicator').style.display = 'none';
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.pause();
                }
            } else {
                modal.style.display = 'none';
                document.getElementById('recordingIndicator').style.display = 'inline-flex';
                if (mediaRecorder && mediaRecorder.state === 'paused') {
                    mediaRecorder.resume();
                }
            }
        }, 600);
    }
    


    // Start by showing data privacy consent
    showPrivacyConsent();
</script>
{% endblock %}
