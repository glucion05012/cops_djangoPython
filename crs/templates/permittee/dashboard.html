{% extends "includes/base.html" %}

{% block title %}DENR NCR Client Portal{% endblock title %}

{% block content %}
    <div class="row">

        <div class="col-sm-12">

            <div class="trans-layout card  mb-4">
                <div class="form-group">
                    <a class="viewbtn btn btn-success btn-sm waves-effect waves-light" href="#" id="addPermitteeBtn"><span class="btn-label"><i class="fas fa-plus"></i></span> ADD PERMITTEE</a>
            
                    <p style="color:red"><i>To Modify or Delete your permittee, Please call 09285065682. Thank you.</i></p>
                </div>

                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-address-card"></i> PERMITTEE INFORMATION</h6>
                </div>
            </div>
        </div>

        <div class="col-sm-12">
            <table id="myTableList" class="table table-responsive table-striped table-bordered table-sm" cellspacing="0" width="100%" >
                <thead>
                    <tr>
                        <th>Permittee Name</th>
                        <th>Address</th>
                        <th>Email</th>
                        <th>Contact No.</th>
                        <!-- <th>Action</th> -->
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

    </div>

    <!-- add permittee modal -->
    <div class="modal fade" id="addPermitteeModal" tabindex="-1" role="dialog" aria-labelledby="addBusinessModalLabel" aria-hidden="true">
        <form id="addPermitteeForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBusinessModalLabel">Add Permittee Information</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="businessName">Permittee Name</label>
                        <input type="text" class="form-control" id="businessName" name="businessName">
                    </div>
                    <div class="form-group">
                        <label for="address">Permittee Address</label>
                        <input type="text" class="form-control" id="businessAddress" name="businessAddress">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="text" class="form-control" id="businessEmail" name="businessEmail">
                    </div>
                    <div class="form-group">
                        <label for="contact">Tel No.</label>
                        <input type="text" class="form-control" id="businessCel" name="businessCel">
                    </div>
                    <div class="form-group">
                        <label for="contact">Celphone No.</label>
                        <input type="text" class="form-control" id="businessTel" name="businessTel">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="savePermitteeBtn">Save</button>
                </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        $(document).ready(function() {
            $('#myTableList').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "{% url 'permittee_list_json' %}",
                    "type": "POST",
                    "headers": { "X-CSRFToken": "{{ csrf_token }}" }
                },
                "columns": [
                    { "data": "permittee_name" },
                    { "data": "address" },
                    { "data": "email" },
                    { "data": "contact_no" }
                ]
            });
        });


        $(document).on('click', '#addPermitteeBtn', function() {
            $('#addPermitteeModal').modal('show');
        });

        $(document).on('click', '#savePermitteeBtn', function() {
            
            var businessName = $('#businessName').val();
            var businessAddress = $('#businessAddress').val();
            var businessEmail = $('#businessEmail').val();
            var businessCel = $('#businessCel').val();
            var businessTel = $('#businessTel').val();

            if(!businessName || !businessAddress || !businessEmail || !businessCel || !businessTel) {
                Swal.fire({
                    title: "Error",
                    text: "Please fill in all fields.",
                    icon: "error",
                    confirmButtonColor: "#d33",
                });
            }else{
                var emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                if (!emailPattern.test(businessEmail)) {
                    Swal.fire({
                        title: "Error",
                        text: "Please enter a valid email address.",
                        icon: "error",
                        confirmButtonColor: "#d33",
                    });
                }else{
                    $.ajax({
                        type: "POST",
                        url: "{% url 'add_permittee' %}",
                        data: {
                            businessName: businessName,
                            businessAddress: businessAddress,
                            businessEmail: businessEmail,
                            businessCel: businessCel,
                            businessTel: businessTel,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function(response) {
                            if (response.status === 'success') {
                                $('#addPermitteeModal').modal('hide');
                                $('#myTableList').DataTable().ajax.reload();
                                Swal.fire({
                                    title: "Success",
                                    text: "Permittee added successfully.",
                                    icon: "success",
                                    confirmButtonColor: "#3085d6",
                                });
                            } else {
                                Swal.fire({
                                    title: "Error",
                                    text: response.message,
                                    icon: "error",
                                    confirmButtonColor: "#d33",
                                 });
                            }
                        }
                    });
                }
               
            }
        });
    </script>
{% endblock %}