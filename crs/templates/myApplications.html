{% extends "includes/base.html" %}

{% block title %}DENR NCR Client Portal{% endblock title %}
{% load static %}

{% block content %}
    <div class="row">
        <div class="col-sm-12">
            <table id="myApplicationList" class="table table-responsive table-striped table-bordered table-sm" cellspacing="0" width="100%" >
                <thead>
                    <tr>
                        <th>Permit</th>
                        <th>Permittee Name</th>
                        <th>Reference Number</th>
                        <th>Date Applied</th>
                        <th>Status</th>
                        <th>Remarks</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

    </div>


    <div class="modal fade" id="applicationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Application Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="applicationModalBody">

                    <div style="text-align: center;">
                        <b>APPLICATION FOR <span id="application_for" style="text-transform: uppercase;"></span></b>
                        <br>
                        Permit No. <span class="text-muted" id="reference_no"></span>
                    </div>

                    <div class="hr-sect">Application Information</div>
                    <div class="row">
                        
                        <div class="col-md-2">
                            <label for="application_type" class="form-label">Application Type</label>
                        </div>
                        <div class="col-md-1">
                            :
                        </div>
                        <div class="col-md-3">
                            <div id="application_type"></div>
                        </div>

                        <div class="col-md-2">
                            <label for="date_applied" class="form-label">Date Applied</label>
                        </div>
                        <div class="col-md-1">
                            :
                        </div>
                        <div class="col-md-3">
                            <div id="date_applied"></div>
                        </div>

                        <div class="col-md-2">
                            <label for="applicant_type" class="form-label">Applicant Type</label>
                        </div>
                        <div class="col-md-1">
                            :
                        </div>
                        <div class="col-md-3">
                            <div id="applicant_type"></div>
                        </div>

                        <div id="ownershsip_type"></div>

                        <div class="col-md-2">
                            <label for="client_cel_no" class="form-label">Contact No</label>
                        </div>
                        <div class="col-md-1">
                            :
                        </div>
                        <div class="col-md-3">
                            <div id="client_cel_no"></div>
                        </div>

                        <div class="col-md-2">
                            <label for="applicant_name" class="form-label">Applicant Name</label>
                        </div>
                        <div class="col-md-1">
                            :
                        </div>
                        <div class="col-md-3">
                            <div id="client_name"></div>
                        </div>

                        <div class="col-md-2">
                            <label for="client_email" class="form-label">Email</label>
                        </div>
                        <div class="col-md-1">
                            :
                        </div>
                        <div class="col-md-3">
                            <div id="client_email"></div>
                        </div>

                    </div>

                    <!-- Placeholder for the additional label -->
                
                    <!-- Permittee Name -->
                    <div class="hr-sect">General Information</div>

                    <div class="row">
                        <div class="col-md-12">
                            <h5 style="text-align: center;">
                                <b id="permit_name"></b>
                            </h5>
                            <p style="text-align: center;" id="permit_address"></p>
                        </div>

                    </div>

                    {% comment %} ------------- other information ------------- {% endcomment %}
                    <div id="other_information"></div>

                    
                    <div class="hr-sect">Attachments</div>

                    <div id="attachments"></div>

                </div>
            </div>
        </div>
    </div>

    <!-- Proof of Payment Modal -->
    <div class="modal fade" id="proofOfPaymentModal" tabindex="-1" aria-labelledby="proofOfPaymentLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="proofOfPaymentForm" enctype="multipart/form-data">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="proofOfPaymentLabel">Attach Proof of Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                <div class="mb-3">
                    <input type="hidden" id="payment_id_or" name="payment_id" value="">
                    <input type="hidden" id="permit_type_or" name="permit_type" value="">
                    <input type="hidden" id="app_id_or" name="app_id" value="">
                    <label for="proof_file" class="form-label">Upload File <small class="text-muted">(PDF, JPG, PNG)</small></label>
                    <input type="file" class="form-control" id="proof_file" name="proof_file" accept=".pdf,.jpg,.jpeg,.png" multiple>
                </div>

                <div class="mb-3">
                    <label for="proof_remarks" class="form-label">OR Number</label><span class="text-danger">*</span>
                    <input type="text" class="form-label" id="or_no" name="or_no" value="" required>
                </div>

                <div class="mb-3">
                    <label for="proof_remarks" class="form-label">Remarks (optional)</label>
                    <textarea class="form-control" id="proof_remarks_or" name="remarks" rows="2"></textarea>
                </div>
                </div>

                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="upload_or_btn btn btn-primary">Upload</button>
                </div>
            </div>
            </form>
        </div>
    </div>

    {% comment %} Order of Payment Modal {% endcomment %}
    <div class="modal fade" id="orderOfPaymentModal" tabindex="-1" aria-labelledby="orderOfPaymentLabel-{{ op_data.app_id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content shadow">

                <div class="modal-header">
                    <h5 class="modal-title" id="orderOfPaymentLabel-{{ op_data.app_id }}">Order of Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="container p-3 border border-dark rounded">

                    <!-- Header -->
                    <div class="text-center mb-4">
                        <img src="{% static 'images/denr-logo.png' %}" alt="DENR Logo" width="50">
                        <h4 class="mt-3"><strong>ORDER OF PAYMENT</strong></h4>
                        <p>DEPARTMENT OF ENVIRONMENT AND NATURAL RESOURCES</p>
                        <p>NATIONAL CAPITAL REGION</p>
                        <p class="mb-0"><b><span id='permit_type_op'></span></b></p>
                    </div>

                    <!-- Info Rows -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <table class="table table-sm w-100 border border-dark">
                                <tbody>
                                    <tr>
                                        <td class="fw-bold text-end pe-3" style="width: 50%;">Date Created:</td>
                                        <td><span id="op_date_op"></span></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold text-end pe-3">Reference No.:</td>
                                        <td><span id="reference_no_op"></span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm w-100 border border-dark">
                                <tbody>
                                    <tr>
                                        <td class="fw-bold text-end pe-3" style="width: 50%;">Order of Payment No.:</td>
                                        <td><span id="op_no_op"></span></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold text-end pe-3">OR Number:</td>
                                        <td><span id="or_no_op"></span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>


                    <!-- Payee Info -->
                    <div class="mb-4">
                        <p><strong>Payor:</strong> <span id='estab_name_op'></span></p>
                        <p><strong>Address:</strong> <span id='estab_address_op'></span></p>
                    </div>

                    <!-- Payment Table -->
                    <table class="table table-bordered text-center align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Particulars</th>
                            <th>Amount (₱)</th>
                        </tr>
                        </thead>
                        <tbody>
                            <tr>
                            <td>
                            Permit Fee
                            </td>
                            <td><span id='amount_op'></span></td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Fund Cluster -->
                    <p class="mt-3"><strong>Fund Cluster:</strong> {{ op_data.fund_cluster|default:"0110110" }}</p>

                    <!-- Signature -->
                    <div class="text-center mt-5">
                        <img src="{% static 'images/sc-esig.png' %}" alt="Signature" width="100">
                        <div><strong>EMELYN JOYCE E. NUGUID</strong></div>
                        <div class="text-muted">Chief, Forest Utilization Section</div>
                    </div>
                    </div>
                </div>

                <div class="modal-footer d-print-none">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printOrderOfPayment()">Print</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        $(document).ready(function() {
            $('#myApplicationList').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "{% url 'application_list_json' %}",
                    "type": "POST",
                    "headers": { "X-CSRFToken": "{{ csrf_token }}" }
                },
                "columns": [
                    { "data": "permit_type" },
                    { "data": "estab_name" },
                    { "data": "reference_no" },
                    {
                        "data": "date_applied",
                        "render": function(data, type, row) {
                            if (!data) return '';
                            const date = new Date(data);
                            return date.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                        }
                    },
                    {
                        "data": "status",
                        "render": function(data, type, row) {
                            if (!data) return '';
                            return data.charAt(0).toUpperCase() + data.slice(1);
                        }
                    },
                    {
                        "data": "client_remarks",
                        "render": function(data, type, row) {
                            if (row.survey != 1 && row.status === 'approved') {
                                return 'Please Complete Client Satisfaction Survey';
                            }else{
                                if (!data) return '';
                                return data.charAt(0).toUpperCase() + data.slice(1);
                            }
                        }
                    },
                    {
                        "data": null,
                        "render": function(data, type, row) {
                            let buttons = `
                            <button class="btn btn-sm btn-primary view-btn" data-appid="${row.app_id}" data-reference="${row.reference_no}" data-permit_type_short="${row.permit_type_short}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            `;

                            if (row.client_notes === "Returned to Client") {
                                buttons += `
                                <button class="btn btn-sm btn-warning edit-btn" data-appid="${row.app_id}" data-reference="${row.reference_no}" data-permit_type_short="${row.permit_type_short}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                `;
                            }else if (row.client_notes === "For Payment" && row.paid_status === "0") {
                                buttons += `
                                <button class="btn btn-sm btn-warning op-btn" title="Order of Payment" data-reference="${row.reference_no}" data-appid="${row.app_id}" data-permit_type_short="${row.permit_type_short}">
                                        <i class="fas fa-receipt"></i>
                                    </button>
                                <button class="btn btn-sm btn-success or-btn" title="Upload Proof of Payment" data-reference="${row.reference_no}" data-appid="${row.app_id}" data-permit_type_short="${row.permit_type_short}">
                                        <i class="fas fa-hand-holding-dollar"></i>
                                    </button>
                                `;
                            }else if (row.survey != 1 && row.status === 'approved') {
                                buttons += `
                                <button class="btn btn-sm btn-warning css-btn" data-appid="${row.app_id}" data-reference="${row.reference_no}" data-permit_type_short="${row.permit_type_short}">
                                        <i class="fa-solid fa-square-poll-vertical"></i>
                                    </button>
                                `;
                            }

                            return buttons;
                        },
                        "orderable": false,
                        "searchable": false
                    }
                ]
            });
        });

        $(document).on('click', '.view-btn', function () {
            const appid = $(this).data('appid');
            const referenceNo = $(this).data('reference');
            const permit_type_short = $(this).data('permit_type_short');
            // Fetch data from the server using AJAX
            $.ajax({
                url: '/get-application-details/', // Your Django view URL
                method: 'GET',
                data: { appid: appid,
                        reference_no: referenceNo,
                        permit_type_short: permit_type_short},
                success: function (response) {
                    // Populate the textboxes with data
                    $('#application_for').html(response.permit_type);
                    $('#reference_no').html(response.reference_no);
                    if (response.app_type === '1') {
                        $('#applicant_type').html('Individual');
                    }else if (response.app_type === '2') {
                        $('#applicant_type').html('Government');
                    } else if (response.app_type === '3') {
                        $('#applicant_type').html('Corporation');
                    }
                    
                    if (response.permit_type_short === 'TCP') {
                        $('#application_type').html('New Permittee');
                    } else if (response.permit_type_short === 'PIC') {
                        if (response.is_existing_permittee == '0') {
                            $('#application_type').html('New Permittee');
                        } else if (response.is_existing_permittee == '1') {
                            $('#application_type').html('Existing Permittee');
                        } else {
                            $('#application_type').html('Unknown');
                        }
                    }

                    if (response.permit_type_short === 'TCP') {
                        if ($('#applicant_type_row').length === 0) {
                            $('#ownershsip_type').closest('.row').after(`
                                <div class="row" id="applicant_type_row">
                                    <div class="col-md-2">
                                        <label for="applicant_type" class="form-label">Ownership</label> 
                                    </div>
                                    <div class="col-md-1">
                                        :
                                    </div>
                                    <div class="col-md-3">
                                         ${response.owner}
                                    </div>
                                </div>
                            `);
                        }
                    } else {
                        $('#applicant_type_row').remove(); // Remove it if not TCP
                    }

                    if (response.date_applied) {
                        const parts = response.date_applied.split('-');

                        const months = [
                            'January', 'February', 'March', 'April', 'May', 'June',
                            'July', 'August', 'September', 'October', 'November', 'December'
                        ];

                        const year = parts[0];
                        const month = months[parseInt(parts[1], 10) - 1];
                        const day = parseInt(parts[2], 10);
                        response.date_applied = `${month} ${day}, ${year}`; // Format it in-place
                    }
                    $('#date_applied').html(response.date_applied);

                    $('#permit_name').html(response.estab_name);
                    $('#permit_address').html(response.estab_address);
                    $('#client_cel_no').html(response.client_cel_no);
                    $('#client_email').html(response.client_email);
                    $('#client_name').html(response.client_name);
                    

                    //----------------- chainsaw fields -----------------
                    if (response.permit_type_short === 'PIC') {
                        // Always remove the previous section before adding
                        $('#other_info_row').remove();

                        $('#other_information').after(`
                            <div id="other_info_row" class="row mt-3">
                                <div class="col-12">
                                    <div class="hr-sect">Warehouse Information</div>
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">City</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.warehouse_city}
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">Address</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.warehouse_address}
                                </div>

                                <div class="col-12">
                                    <div class="hr-sect">Chainsaw Details</div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Brand</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.brand_name}
                                </div>

                                <div class="col-12 mt-4" style="margin-bottom: 2rem;">
                                    <label class="form-label fw-bold">Models and Quantities</label>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-striped table-hover align-middle mb-0">
                                            <thead class="table-secondary">
                                                <tr class="text-center">
                                                    <th style="width: 70%;">Model</th>
                                                    <th style="width: 30%;">Quantity</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${
                                                    response.models && response.models.length > 0 ?
                                                    response.models.map(m => `
                                                        <tr>
                                                            <td class="ps-3">${m.model}</td>
                                                            <td class="text-center">${m.quantity} unit/s</td>
                                                        </tr>
                                                    `).join('') :
                                                    `<tr><td colspan="2" class="text-center text-muted fst-italic">No models found</td></tr>`
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">Country of Origin/Supplier</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.origin}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Expected Time of Arrival</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.arrival_date}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Purpose</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.purpose}
                                </div>

                            </div>
                        `);

                        //attachments
                        $('#attachments_table').remove();
                        $('#attachments').after(`
                            <table id="attachments_table" class="table table-bordered table-striped table-hover align-middle mb-0 mt-3">
                                <thead class="table-secondary">
                                    <tr>
                                        <th>File Type</th>
                                        <th>Files</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${
                                        (() => {
                                            if (!response.attachments || response.attachments.length === 0) {
                                                return `<tr><td colspan="2" class="text-center text-muted fst-italic">No attachments found</td></tr>`;
                                            }

                                            // Group by file_type
                                            const grouped = {};
                                            response.attachments.forEach(att => {
                                                if (!grouped[att.file_type]) {
                                                    grouped[att.file_type] = [];
                                                }
                                                grouped[att.file_type].push(att);
                                            });

                                            // Generate table rows
                                            return Object.entries(grouped).map(([type, files]) => `
                                                <tr>
                                                    <td>${type}</td>
                                                    <td>
                                                        <div class="dropdown">
                                                            <button class="btn btn-sm btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                Download
                                                            </button>
                                                            <ul class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">
                                                                ${
                                                                    files.map(file => `
                                                                        <li>
                                                                            <a class="dropdown-item d-flex justify-content-between align-items-center" href="${file.file_url}" target="_blank">
                                                                                ${file.file_name} &nbsp;&nbsp;
                                                                                <i class="fas fa-download text-primary"></i>
                                                                            </a>
                                                                        </li>
                                                                    `).join('')
                                                                }
                                                            </ul>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('');
                                        })()
                                    }
                                </tbody>
                            </table>
                        `);
                    } else if (response.permit_type_short === 'TCP') {
                        // Always remove the previous section before adding
                        $('#other_info_row').remove();

                        $('#other_information').after(`
                            <div id="other_info_row" class="row mt-3">
                                <div class="col-12">
                                    <div class="hr-sect">Permit Information</div>
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">Purpose</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.purpose.charAt(0).toUpperCase() + response.purpose.slice(1) }
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Purpose Reason</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.purpose_reason}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Tree Address</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-9">
                                    ${response.tree_location}
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">Private Property</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-9">
                                    ${response.within_property === 'within' ? 'Yes' : 'No - '+response.within_property_others}
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">Subdivision</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.within_subdivision === 'within' ?  'Yes - '+response.within_subdivision_others : 'No'}
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">School/Organization</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.within_school === 'within' ?  'Yes' : 'No'}
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">Area Covered</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.area_covered} sq. m.
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">No. of Trees Affected</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.no_of_trees_affected}
                                </div>

                                <div class="col-md-9">
                                    <label class="form-label">Can trees/shrubs/ornamental plants be planted in your are to replace the subject tree/s?</label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-2">
                                    ${response.tree_replace}
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">If No, </label>
                                </div>
                                <div class="col-md-1">
                                    :
                                </div>
                                <div class="col-md-3">
                                    ${response.tree_replace_reason}
                                </div>
                            </div> 
                        `);
                    
                        //attachments
                        $('#attachments_table').remove();
                        $('#attachments').after(`
                            <table id="attachments_table" class="table table-bordered table-striped table-hover align-middle mb-0 mt-3">
                                <thead class="table-secondary">
                                    <tr>
                                        <th>File Name</th>
                                        <th>File Type</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${
                                        response.attachments && response.attachments.length > 0 ?
                                        response.attachments.map(att => `
                                            <tr>
                                                <td>${att.file_type}</td>
                                                <td>${att.file_name}</td>
                                                <td class="text-center">
                                                    <a href="${att.file_url}" target="_blank" class="btn btn-sm btn-primary">
                                                        <i class="fas fa-download"></i> Download
                                                    </a>
                                                </td>
                                            </tr>
                                        `).join('') :
                                        `<tr><td colspan="3" class="text-center text-muted fst-italic">No attachments found</td></tr>`
                                    }
                                </tbody>
                            </table>
                        `);

                    }else {
                        $('#other_info_row').remove();
                    }

                    // Populate other fields as needed

                    // Show the modal after data is loaded
                    $('#applicationModal').modal('show');
                },
                error: function () {
                    alert('Failed to fetch application details.');
                }
            });
        });

        $(document).on('click', '.op-btn', function () {
            const appid = $(this).data('appid');
            const referenceNo = $(this).data('reference');
            const permit_type_short = $(this).data('permit_type_short');

                $.ajax({
                url: '/get-application-details/', // Your Django view URL
                method: 'GET',
                data: { appid: appid,
                        reference_no: referenceNo,
                        permit_type_short: permit_type_short},
                success: function (response) {

                     if (response.op_date) {
                        const parts = response.op_date.split('-');

                        const months = [
                            'January', 'February', 'March', 'April', 'May', 'June',
                            'July', 'August', 'September', 'October', 'November', 'December'
                        ];

                        const year = parts[0];
                        const month = months[parseInt(parts[1], 10) - 1];
                        const day = parseInt(parts[2], 10);
                        response.op_date = `${month} ${day}, ${year}`; // Format it in-place
                    }

                    $('#permit_type_op').html(response.permit_type);
                    $('#op_date_op').html(response.op_date);
                    $('#reference_no_op').html(response.reference_no);
                    $('#op_no_op').html(response.op_id);
                    $('#or_no_op').html(response.or_no);
                    $('#estab_name_op').html(response.estab_name);
                    $('#estab_address_op').html(response.estab_address);
                    $('#amount_op').html(response.amount);
                }
            });

            $('#orderOfPaymentModal').modal('show');
        });

        $(document).on('click', '.edit-btn', function () {
            const app_id = $(this).data('appid');
            const permitType = $(this).data('permit_type_short');
            window.location.href = `/edit-application/${permitType}/${app_id}/`;
            
        });

        
        $(document).on('click', '.or-btn', function() {
            const permit_type_short = $(this).data('permit_type_short');
            const referenceNo = $(this).data('reference');
            const appid = $(this).data('appid');

            $.ajax({
                url: '/get-application-details/', // Your Django view URL
                method: 'GET',
                data: { appid: appid,
                        reference_no: referenceNo,
                        permit_type_short: permit_type_short},
                success: function (response) {

                    $('#payment_id_or').val(response.payment_id);
                    $('#permit_type_or').val(permit_type_short);
                    $('#app_id_or').val(response.id);
                    
                    $('#proofOfPaymentModal').modal('show');
                }
            });
        });

        $('#proofOfPaymentForm').on('submit', function(e) {
            e.preventDefault();

            const files = $('#proof_file')[0].files;

            if (!files.length) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Files Required',
                    text: 'Please select at least one file to upload.'
                });
                return;
            }

           // 🔹 Get values from form inputs
            const app_id = $('#app_id_or').val();
            const permit_type = $('#permit_type_or').val();
            const remarks = $('#proof_remarks_or').val().trim();
            const or_no = $('#or_no').val().trim();
            const payment_id = $('#payment_id_or').val();

            const formData = new FormData();
            formData.append('app_id', app_id);
            formData.append('permit_type', permit_type);  // renamed from payment_id
            formData.append('remarks', remarks);
            formData.append('payment_id', payment_id);
            formData.append('or_no', or_no);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            // 🔹 Append each file
            for (let i = 0; i < files.length; i++) {
                formData.append('proof_file', files[i]);  // must match Django's expected name
            }

            $.ajax({
                type: 'POST',
                url: "{% url 'upload_proof' %}",
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Upload Successful',
                            text: 'All selected files have been uploaded.'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Upload Failed',
                            text: response.message || 'An unknown error occurred.'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Request Error',
                        text: `Error: ${error}`
                    });
                }
            });
            
        });

        $(document).on('click', '.css-btn', function () {
            const app_id = $(this).data('appid');
            const permitType = $(this).data('permit_type_short');
            const referenceNo = $(this).data('reference');
            
            //window.location.href = `/edit-application/${permitType}/${app_id}/`;
            
        });

        function printOrderOfPayment() {
            const modalContent = document.querySelector('#orderOfPaymentModal .modal-content').cloneNode(true);

            // Create a new print window
            const printWindow = window.open('', '', 'height=900,width=700');

            printWindow.document.write(`
                <html>
                <head>
                    <title>DENR NCR ORDER OF PAYMENT</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body {
                            margin: 0;
                            padding: 30px;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            background-color: #fff;
                            text-align: center;
                        }

                        .modal-content {
                            width: 100%;
                            max-width: 900px;
                            margin: auto;
                            box-shadow: none;
                            border: none;
                        }

                        .modal-header, .modal-footer, .btn-close, .d-print-none {
                            display: none !important;
                        }

                        table {
                            border: 1px solid #dee2e6;
                            border-collapse: collapse;
                            width: 100%;
                            margin-top: 20px;
                        }

                        th, td {
                            border: 1px solid #dee2e6;
                            padding: 10px;
                            text-align: center;
                        }

                        img {
                            margin-bottom: 10px;
                        }

                        .signature {
                            margin-top: 60px;
                            text-align: center;
                        }

                        .signature img {
                            margin-bottom: 10px;
                        }

                        .signature div {
                            line-height: 1.2;
                        }
                    </style>
                </head>
                <body>
            `);

            printWindow.document.body.appendChild(modalContent);
            printWindow.document.write(`</body></html>`);
            printWindow.document.close();
            printWindow.focus();

            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

    </script>
{% endblock %}
